rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // ARTICLES COLLECTION RULES
    // ============================================
    match /articles/{articleId} {
      
      // Anyone can read articles (public access)
      allow read: if true;
      
      // Only authenticated users can create articles
      // Must validate schema and ensure userId matches auth.uid
      allow create: if isAuthenticated() 
                    && isValidArticleSchema()
                    && request.resource.data.userId == request.auth.uid;
      
      // Only the author can update their own articles (full update)
      // Must validate schema and prevent changing userId
      allow update: if isAuthenticated()
                    && isOwner()
                    && isValidArticleSchema()
                    && request.resource.data.userId == resource.data.userId;
      
      // Any authenticated user can update reactions only
      allow update: if isAuthenticated()
                    && isReactionUpdate();
      
      // Only the author can delete their own articles
      allow delete: if isAuthenticated() && isOwner();
    }
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if authenticated user is the owner of the article
    function isOwner() {
      return request.auth.uid == resource.data.userId;
    }
    
    // Check if update only affects reaction fields
    // Allows any authenticated user to add/remove reactions
    function isReactionUpdate() {
      let allowedFields = ['reactions', 'userReactions'].toSet();
      let changedFields = request.resource.data.diff(resource.data).affectedKeys();
      return changedFields.hasOnly(allowedFields);
    }
    
    // Validate article schema
    function isValidArticleSchema() {
      let data = request.resource.data;
      let requiredFields = ['author', 'title', 'description', 'content', 'urlToImage', 'publishedAt', 'createdAt', 'userId'];
      
      return data.keys().hasAll(requiredFields)
        && data.author is string
        && data.author.size() > 0
        && data.author.size() <= 100
        && data.title is string
        && data.title.size() > 0
        && data.title.size() <= 200
        && data.description is string
        && data.description.size() > 0
        && data.description.size() <= 500
        && data.content is string
        && data.content.size() > 0
        && data.urlToImage is string
        && data.urlToImage.size() > 0
        && data.publishedAt is timestamp
        && data.createdAt is timestamp
        && data.userId is string
        && data.userId.size() > 0
        // Optional field validation
        && (!("url" in data.keys()) || data.url is string)
        && (!("source" in data.keys()) || data.source is string)
        && (!("reactions" in data.keys()) || data.reactions is map)
        && (!("userReactions" in data.keys()) || data.userReactions is map);
    }
  }
}